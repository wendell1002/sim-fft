#![no_std]
#![no_main]

use cortex_m::singleton;
use cortex_m_rt::entry;
use defmt::info;
use defmt_rtt as _;
use fugit::ExtU32 as _;
use fugit::Rate;
use panic_semihosting as _;

use sim_fft::{Complex, SimpleFft};
use stm32f1xx_hal::gpio::{self, Pin};
use stm32f1xx_hal::pac::ADC1;
use stm32f1xx_hal::rcc;
use stm32f1xx_hal::timer::{Channel, Tim2NoRemap};
use stm32f1xx_hal::{
    adc::{Adc, SampleTime},
    pac::{self},
    prelude::*,
    time::MonoTimer,
};

#[entry]
fn main() -> ! {
    //1Mhz
    let freq = 1_000_000;
    //93KHZ
    let mut buf = [
        4091, 4089, 4091, 4093, 4092, 4091, 2, 1, 1, 1, 1, 1, 4092, 4091, 4091, 4092, 4093, 2, 2,
        1, 1, 1, 4090, 4091, 4092, 4093, 4093, 4092, 2, 1, 1, 2, 1, 4092, 4093, 4093, 4093, 4091,
        2, 1, 2, 1, 2, 2, 4093, 4093, 4091, 4092, 4093, 2, 2, 1, 2, 1, 1, 4093, 4092, 4092, 4091,
        4092, 2, 2, 1, 1, 2, 4092, 4092, 4091, 4092, 4092, 4091, 2, 1, 2, 1, 2, 4091, 4094, 4093,
        4091, 4093, 2, 2, 1, 1, 1, 1, 4092, 4091, 4093, 4093, 4092, 2, 1, 1, 2, 1, 2, 4092, 4092,
        4093, 4094, 4093, 2, 2, 1, 2, 1, 4092, 4091, 4092, 4092, 4091, 4092, 2, 2, 1, 1, 1, 4092,
        4092, 4089, 4090, 4093, 3, 2, 1, 1,
    ];
    cal_hz(&mut buf, freq as f64, freq as f64);
    //221KHZ
    let mut buf = [
        4089, 4089, 1, 0, 4089, 4091, 4092, 0, 0, 4092, 4091, 1, 0, 4089, 4090, 4092, 2, 0, 4092,
        4090, 1, 0, 4089, 4091, 4092, 1, 0, 4090, 4090, 1, 0, 4089, 4090, 4090, 1, 0, 4092, 4090,
        1, 1, 4089, 4090, 4092, 1, 1, 4092, 4092, 1, 0, 4045, 4090, 4092, 1, 0, 4091, 4090, 1, 0,
        0, 4090, 4092, 1, 0, 4091, 4091, 0, 0, 0, 4090, 4091, 1, 0, 4090, 4089, 1, 0, 0, 4090,
        4091, 1, 0, 4092, 4091, 1, 0, 0, 4090, 4092, 1, 0, 4092, 4091, 1, 1, 0, 4090, 4090, 1, 0,
        4093, 4091, 1, 0, 0, 4091, 4092, 1, 1, 4092, 4091, 0, 1, 0, 4090, 4092, 1, 0, 4092, 4090,
        1078, 0, 0, 4092, 4092, 1, 0, 4092, 4091,
    ];
    cal_hz(&mut buf, freq as f64, freq as f64);
    //250Khz
    let mut buf = [
        1, 1, 1, 4092, 4092, 1, 0, 4089, 4089, 1, 0, 4089, 4092, 1, 0, 4092, 4092, 1, 0, 4092,
        4089, 1, 0, 4091, 4092, 1, 0, 4092, 4092, 1, 0, 4090, 4091, 1, 0, 4089, 4091, 1, 1, 4092,
        4092, 1, 0, 4092, 4089, 1, 0, 4089, 4092, 1, 0, 4092, 4092, 1, 0, 4091, 4091, 0, 0, 4090,
        4092, 1, 0, 4092, 4092, 1, 0, 4092, 4091, 1, 1, 4089, 4092, 1, 1, 4092, 4090, 1, 0, 4092,
        4091, 1, 0, 4089, 4092, 1, 0, 4092, 4092, 1, 0, 4091, 4089, 1, 0, 4091, 4092, 1, 1, 4090,
        4089, 1, 0, 4092, 4091, 0, 0, 4089, 4092, 1, 1, 4092, 4092, 1, 0, 4092, 4089, 1, 0, 4089,
        4092, 1, 0, 4090, 4090, 1, 0, 4092,
    ];
    cal_hz(&mut buf, freq as f64, freq as f64);
    //125khz
    let mut buf = [
        1, 4089, 4089, 0, 0, 0, 0, 4091, 4089, 4092, 4092, 1, 0, 0, 0, 4092, 4092, 4089, 4092, 1,
        1, 0, 0, 4091, 4092, 4091, 4089, 1, 0, 1, 0, 4092, 4091, 4092, 4092, 1, 0, 0, 1, 4092,
        4091, 4091, 4092, 1, 0, 0, 0, 4089, 4092, 4092, 4091, 1, 1, 0, 0, 4091, 4089, 4092, 4090,
        1, 0, 0, 0, 4090, 4091, 4091, 4092, 1, 0, 0, 0, 4089, 4092, 4092, 4089, 1, 0, 0, 0, 4091,
        4089, 4090, 4089, 1, 0, 0, 0, 4092, 4092, 4089, 4092, 1, 1, 0, 0, 4091, 4092, 4092, 4089,
        1, 0, 1, 0, 4090, 4090, 4090, 4092, 1, 0, 0, 1, 4092, 4092, 4091, 4092, 1, 0, 0, 0, 4089,
        4092, 4092, 4091, 1, 1, 1, 0, 4091,
    ];
    cal_hz(&mut buf, freq as f64, freq as f64);
    panic!("exit");
    loop {}
}

const ADC_BUFFER_SIZE: usize = 128;

fn cal_hz(buf: &mut [u16], clk1: f64, clk2: f64) {
    //大小为2^n
    let mut sin_table = [0.0; ADC_BUFFER_SIZE / 4 + 1];
    let mut data = [Complex::new(0.0, 0.0); ADC_BUFFER_SIZE];
    let mut fft = SimpleFft::new(&mut data, &mut sin_table, clk2 as f64);
    fft.init_sin_table();
    // 模拟 ADC 数据（u16）
    fft.load_data_u16(&buf);
    // 加窗（可选）
    fft.apply_kaiser_window(5.);
    // fft.apply_hamming_window();
    // 执行 FFT
    fft.fft();

    // /获取主频
    let (freq1, _) = fft.dominant_frequency();
    let (freq2, mag) = fft.dominant_freq(clk1);
    let freq = (freq1 + freq2) / 2000.;
    info!("主频率:{}+{}= {} KHz, 幅度: {}", freq1, freq2, freq, mag);

    // // 打印前10个频点
    // for i in 1..=10 {
    //     info!("f={}Hz, mag={}", fft.frequency(i), fft.magnitude(i));
    // }
}
